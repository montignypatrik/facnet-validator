# RAMQ Validation Rule: Optimisation intervention clinique

R√®gle d'optimisation pour d√©tecter les visites r√©guli√®res qui pourraient √™tre factur√©es comme interventions cliniques pour un revenu sup√©rieur.

---

## Rule Information

**Rule Name (French)**: `Optimisation intervention clinique vs visite r√©guli√®re`

**Rule ID**: `VISIT_DURATION_OPTIMIZATION`

**Rule Type**: `revenue_optimization` (custom type)

**Severity**: Mixed (info, optimization depending on scenario)

**Category**: `revenue_optimization`

---

## Rule Logic Description

### What This Rule Validates:
```
Cette r√®gle identifie les visites r√©guli√®res qui ont une dur√©e document√©e
(heure de d√©but et heure de fin) et calcule si la facturation en tant
qu'intervention clinique (code 8857 + p√©riodes suppl√©mentaires 8859)
serait plus avantageuse financi√®rement.

La r√®gle analyse :
1. Visites avec dur√©e ‚â• 30 minutes (seuil minimum l√©gal)
2. Comparaison du montant actuel vs montant intervention clinique
3. Suggestion de changement si gain financier > 0

Tarification intervention clinique :
- 8857 (30 min) : 59,70$
- 8859 (15 min suppl√©mentaires) : 29,85$ par p√©riode
```

### When Should This Trigger?

See **Validation Scenarios & Expected Results** section below for detailed scenario conditions.

---

## Target Data

### Target Billing Codes:
```javascript
// Tous les codes avec top_level = "B - CONSULTATION, EXAMEN ET VISITE" dans la base de donn√©es
// Exclus : codes 8857 et 8859 (d√©j√† interventions cliniques)

targetTopLevel: "B - CONSULTATION, EXAMEN ET VISITE"
excludedCodes: ["8857", "8859"]
```

### Required Fields:
```javascript
requiredFields: [
  "D√©but",           // Heure de d√©but (format HH:MM)
  "Fin",             // Heure de fin (format HH:MM)
  "Code",            // Code de facturation
  "Montant Preliminaire"  // Montant actuel de la visite
]
```

### Duration Calculation:
```javascript
// Calculer dur√©e en minutes entre D√©but et Fin
// Exemple: D√©but 10:00, Fin 10:35 = 35 minutes

function calculateDuration(debut, fin) {
  const start = parseTime(debut);  // "10:00" -> Date
  const end = parseTime(fin);      // "10:35" -> Date
  return (end - start) / 60000;    // Millisecondes -> Minutes
}
```

---

## Thresholds & Limits

### Minimum Duration:
```javascript
minimumDuration: 30  // minutes (seuil pour code 8857)
```

### Intervention Clinique Pricing:
Note: Il y a 474 codes dans "B - CONSULTATION, EXAMEN ET VISITE" dans la base
```javascript
interventionCliniquePricing: {
  code8857: {
    duration: 30,      // minutes (premi√®re p√©riode)
    amount: 59.70      // dollars
  },
  code8859: {
    duration: 15,      // minutes (p√©riode suppl√©mentaire)
    amount: 29.85      // dollars
  }
}

// Exemples de calcul :
// 30-44 min : 8857 seul = 59,70$
// 45-59 min : 8857 + 8859 (15 min) = 59,70$ + 29,85$ = 89,55$
// 60-74 min : 8857 + 8859 (30 min) = 59,70$ + 59,70$ = 119,40$
// 75-89 min : 8857 + 8859 (45 min) = 59,70$ + 89,55$ = 149,25$
```

### Calculation Logic:
```javascript
function calculateInterventionAmount(durationMinutes) {
  if (durationMinutes < 30) return 0;

  let amount = 59.70;  // Code 8857 de base
  let remaining = durationMinutes - 30;

  if (remaining > 0) {
    // P√©riodes suppl√©mentaires de 15 minutes
    const additionalPeriods = Math.ceil(remaining / 15);
    amount += (additionalPeriods * 29.85);
  }

  return amount;
}
```

---

## Validation Scenarios & Expected Results

> **Purpose:** This section defines ALL possible outcomes of the visit duration optimization rule.
> Each scenario specifies the exact message users will see and how results should be displayed.
>
> **Naming Convention:**
> - P1, P2, P3... = PASS scenarios (severity: info)
> - E1, E2, E3... = ERROR scenarios (severity: error)
> - O1, O2, O3... = OPTIMIZATION scenarios (severity: optimization)

### ‚úÖ PASS Scenarios (Severity: info)

These scenarios represent successful validation. Results should be **collapsed by default**
but expandable to show validation details.

---

#### Scenario P1: No Optimization Needed (Short Visit)

**Condition:** Visite avec dur√©e <30 minutes (insuffisante pour intervention clinique)

**Message (French):**
```
"Validation r√©ussie: Visite {code} de {duration} minutes analys√©e (dur√©e insuffisante pour intervention clinique)"
```

**Solution (French):** `null`

**Monetary Impact:** `0`

**Display Configuration:**
- **Collapsed by default:** Yes
- **Show when expanded:**
  - [X] Temporal information box
  - [ ] Billing details box
  - [ ] Visit statistics grid
  - [ ] Comparison box
- **Custom data fields to display:** `code, duration, currentAmount`

**Test Case Reference:** `test-P1`

**Example ruleData:**
```json
{
  "monetaryImpact": 0,
  "code": "00103",
  "duration": 20,
  "currentAmount": 35.00
}
```

---

#### Scenario P2: Already Intervention Clinique

**Condition:** Code d√©j√† 8857 ou 8859 (d√©j√† intervention clinique)

**Message (French):**
```
"Validation r√©ussie: Code {code} d√©j√† factur√© comme intervention clinique"
```

**Solution (French):** `null`

**Monetary Impact:** `0`

**Display Configuration:**
- **Collapsed by default:** Yes
- **Show when expanded:**
  - [ ] Temporal information box
  - [ ] Billing details box
  - [ ] Visit statistics grid
  - [ ] Comparison box
- **Custom data fields to display:** `code`

**Test Case Reference:** `test-P2`

**Example ruleData:**
```json
{
  "monetaryImpact": 0,
  "code": "8857"
}
```

---

#### Scenario P3: No Time Data

**Condition:** Visite sans heure de d√©but ou fin (dur√©e non calculable)

**Message (French):**
```
"Validation r√©ussie: Visite {code} analys√©e (donn√©es de dur√©e manquantes)"
```

**Solution (French):** `null`

**Monetary Impact:** `0`

**Display Configuration:**
- **Collapsed by default:** Yes
- **Show when expanded:**
  - [ ] Temporal information box
  - [ ] Billing details box
  - [ ] Visit statistics grid
  - [ ] Comparison box
- **Custom data fields to display:** `code, currentAmount`

**Test Case Reference:** `test-P3`

**Example ruleData:**
```json
{
  "monetaryImpact": 0,
  "code": "00103",
  "currentAmount": 35.00,
  "missingData": "debut_fin"
}
```

---

#### Scenario P4: No Financial Gain

**Condition:** Dur√©e ‚â•30 min mais montant intervention ‚â§ montant visite actuelle

**Message (French):**
```
"Validation r√©ussie: Visite {code} de {duration} minutes d√©j√† factur√©e au montant optimal"
```

**Solution (French):** `null`

**Monetary Impact:** `0`

**Display Configuration:**
- **Collapsed by default:** Yes
- **Show when expanded:**
  - [X] Temporal information box
  - [ ] Billing details box
  - [ ] Visit statistics grid
  - [ ] Comparison box
- **Custom data fields to display:** `code, duration, currentAmount, interventionAmount`

**Test Case Reference:** `test-P4`

**Example ruleData:**
```json
{
  "monetaryImpact": 0,
  "code": "00150",
  "duration": 35,
  "currentAmount": 75.00,
  "interventionAmount": 59.70
}
```

---

### üí° FAIL Scenarios - Optimizations (Severity: optimization)

These scenarios represent **missed revenue opportunities**.
Results should be **always visible, highlighted with gain amount**.

---

#### Scenario O1: Simple 30-minute Visit

**Condition:** Visite 30-44 minutes, intervention clinique (8857 seul) plus avantageuse

**Message (French):**
```
"Selon notre analyse, l'intervention clinique est plus avantageuse que la visite {currentCode} factur√©e"
```

**Solution (French):**
```
"Veuillez valider que l'intervention clinique est plus avantageuse et facturer si le seuil de 180 minutes quotidien n'est pas atteint. N'oubliez pas d'ajouter les contextes ICEP, ICSM et ICTOX au besoin"
```

**Monetary Impact:** `{gain}` (positive number - difference between intervention and current)

**Display Configuration:**
- **Collapsed by default:** No (always expanded)
- **Always show:**
  - [X] Optimization message
  - [X] Solution box (highlighted in amber)
  - [X] Monetary gain badge (prominent)
- **Show in details:**
  - [X] Comparison box (current vs intervention)
  - [X] Temporal information box
  - [ ] Billing details box
  - [ ] Visit statistics grid
- **Custom data fields to display:** `currentCode, duration, currentAmount, interventionAmount, gain, suggestedCodes`

**Test Case Reference:** `test-O1`

**Example ruleData:**
```json
{
  "monetaryImpact": 17.20,
  "currentCode": "00103",
  "duration": 30,
  "currentAmount": 42.50,
  "interventionAmount": 59.70,
  "gain": 17.20,
  "suggestedCodes": ["8857"]
}
```

---

#### Scenario O2: 45-minute Visit with Additional Period

**Condition:** Visite 45-59 minutes, intervention clinique (8857 + 8859 15min) plus avantageuse

**Message (French):**
```
"Selon notre analyse, l'intervention clinique est plus avantageuse que la visite {currentCode} factur√©e"
```

**Solution (French):**
```
"Veuillez valider que l'intervention clinique est plus avantageuse et facturer si le seuil de 180 minutes quotidien n'est pas atteint. N'oubliez pas d'ajouter les contextes ICEP, ICSM et ICTOX au besoin"
```

**Monetary Impact:** `{gain}` (positive number)

**Display Configuration:**
- **Collapsed by default:** No (always expanded)
- **Always show:**
  - [X] Optimization message
  - [X] Solution box (highlighted in amber)
  - [X] Monetary gain badge (prominent)
- **Show in details:**
  - [X] Comparison box (current vs intervention)
  - [X] Temporal information box
- **Custom data fields to display:** `currentCode, duration, currentAmount, interventionAmount, gain, suggestedCodes`

**Test Case Reference:** `test-O2`

**Example ruleData:**
```json
{
  "monetaryImpact": 37.55,
  "currentCode": "00113",
  "duration": 45,
  "currentAmount": 52.00,
  "interventionAmount": 89.55,
  "gain": 37.55,
  "suggestedCodes": ["8857", "8859"]
}
```

---

#### Scenario O3: 60-minute Visit

**Condition:** Visite 60-74 minutes, intervention clinique (8857 + 8859 30min) plus avantageuse

**Message (French):**
```
"Selon notre analyse, l'intervention clinique est plus avantageuse que la visite {currentCode} factur√©e"
```

**Solution (French):**
```
"Veuillez valider que l'intervention clinique est plus avantageuse et facturer si le seuil de 180 minutes quotidien n'est pas atteint. N'oubliez pas d'ajouter les contextes ICEP, ICSM et ICTOX au besoin"
```

**Monetary Impact:** `{gain}` (positive number)

**Display Configuration:**
- **Collapsed by default:** No (always expanded)
- **Always show:**
  - [X] Optimization message
  - [X] Solution box (highlighted in amber)
  - [X] Monetary gain badge (prominent)
- **Show in details:**
  - [X] Comparison box (current vs intervention)
  - [X] Temporal information box
- **Custom data fields to display:** `currentCode, duration, currentAmount, interventionAmount, gain, suggestedCodes`

**Test Case Reference:** `test-O3`

**Example ruleData:**
```json
{
  "monetaryImpact": 54.40,
  "currentCode": "00105",
  "duration": 60,
  "currentAmount": 65.00,
  "interventionAmount": 119.40,
  "gain": 54.40,
  "suggestedCodes": ["8857", "8859"]
}
```

---

### üß™ Edge Cases

**Edge Case 1: D√©but/Fin traversent minuit**
- Expected: Calcul correct (ex: 23:30 √† 00:15 = 45 min)

**Edge Case 2: Dur√©e exactement 30 minutes**
- Expected: Optimization si gain > 0 (8857 seul)

**Edge Case 3: Arrondissement p√©riodes suppl√©mentaires**
- Expected: Arrondi AU SUP√âRIEUR par tranches de 15 min (46 min = 8857 + 8859 15min)

**Edge Case 4: Code non-visite (top_level diff√©rent)**
- Expected: Pas d'optimization (exclu de l'analyse)

**Edge Case 5: Montant Preliminaire NULL ou 0**
- Expected: Trait√© comme 0, optimization toujours sugg√©r√©e si dur√©e ‚â•30 min

---

## Old Test Scenarios (Reference Only - To Be Updated)

---

## Implementation Details

### File Structure
```
server/modules/validateur/validation/rules/
‚îú‚îÄ‚îÄ visitDurationOptimizationRule.ts          # Main implementation
‚îî‚îÄ‚îÄ __tests__/
    ‚îî‚îÄ‚îÄ visitDurationOptimizationRule.test.ts # Test suite (29 tests)
```

### Test Coverage
```
‚úÖ 29 test cases covering:
- Pass scenarios (no optimization)
- Optimization scenarios
- Duration calculation edge cases
- Amount validation edge cases
- Informational summary
- French message validation
- Real-world scenarios

Test Coverage: 100% (lines, branches, functions)
```

### Performance
```
- Database query: One-time load of 474 codes (cached)
- Per-record processing: < 1ms
- Typical file (10k records): ~100ms total
- Memory: Minimal (processes sequentially)
```

---

## Examples from Real Data

### Example CSV Input (Optimisation possible):
```csv
#,Facture,Date de Service,D√©but,Fin,Code,Montant Preliminaire,Doctor Info,Patient
1,F001,2025-01-07,10:00,10:35,00103,42.50,DR-001,P001
2,F002,2025-01-07,11:00,11:50,00105,55.00,DR-001,P002
3,F003,2025-01-07,14:00,14:25,00113,35.00,DR-001,P003
```

### Expected Validation Output:
```json
{
  "optimizations": [
    {
      "facture": "F001",
      "severity": "optimization",
      "category": "revenue_optimization",
      "message": "Selon notre analyse, l'intervention clinique est plus avantageuse que la visite 00103 factur√©e.",
      "solution": "Veuillez valider que l'intervention clinique est plus avantageuse et facturer si le seuil de 180 minutes quotidien n'est pas atteint. N'oubliez pas d'ajouter les contextes ICEP, ICSM et ICTOX au besoin.",
      "ruleData": {
        "currentCode": "00103",
        "duration": 35,
        "currentAmount": "42.50",
        "interventionAmount": "59.70",
        "gain": "17.20",
        "potentialRevenue": "17.20",
        "suggestedCodes": ["8857"]
      }
    },
    {
      "facture": "F002",
      "severity": "optimization",
      "category": "revenue_optimization",
      "message": "Selon notre analyse, l'intervention clinique est plus avantageuse que la visite 00105 factur√©e.",
      "solution": "Veuillez valider que l'intervention clinique est plus avantageuse et facturer si le seuil de 180 minutes quotidien n'est pas atteint. N'oubliez pas d'ajouter les contextes ICEP, ICSM et ICTOX au besoin.",
      "ruleData": {
        "currentCode": "00105",
        "duration": 50,
        "currentAmount": "55.00",
        "interventionAmount": "89.55",
        "gain": "34.55",
        "potentialRevenue": "34.55",
        "suggestedCodes": ["8857", "8859"]
      }
    }
  ],
  "info": {
    "severity": "info",
    "message": "Validation optimisation intervention clinique compl√©t√©e: 2 visite(s) analys√©e(s), 2 opportunit√©(s) d'optimisation d√©tect√©e(s). Revenu potentiel: 51.75$.",
    "ruleData": {
      "totalAnalyzed": 2,
      "totalOptimizations": 2,
      "totalPotentialRevenue": "51.75",
      "optimizationRate": "100.0%"
    }
  }
}
```

---

## Business Impact

**Priority**: `Medium`

**Impact**: Moyen √† √©lev√© - Optimisation des revenus pour les m√©decins.

Impact potentiel :
- Gain moyen : 20-40$ par visite optimis√©e
- Fr√©quence : ~5-10% des visites pourraient b√©n√©ficier
- Revenu mensuel additionnel : 1,000$ - 3,000$ par m√©decin

Avantages :
‚úÖ Maximise les revenus l√©gitimes
‚úÖ √âduque les m√©decins sur la facturation optimale
‚úÖ Utilise les donn√©es de dur√©e d√©j√† collect√©es
‚úÖ Aucun risque de rejet RAMQ (codes l√©gitimes)

Cette r√®gle transforme des donn√©es sous-utilis√©es (heures d√©but/fin)
en opportunit√©s de revenus concr√®tes.

---

## Notes & Clarifications

```
IMPORTANT : Cette r√®gle est une suggestion, pas une obligation

Les m√©decins conservent la libert√© de choisir le code appropri√©
selon le contenu clinique de la visite. L'intervention clinique
n√©cessite des crit√®res cliniques sp√©cifiques (counseling, soutien,
information au patient, etc.).

Cette r√®gle identifie seulement les OPPORTUNIT√âS POTENTIELLES
bas√©es sur la dur√©e document√©e.

Pr√©requis pour intervention clinique (article 2.2.6 B) :
- √âquivalent en contenu clinique √† un examen/visite/consultation
- Dur√©e plus longue pour conseil, soutien, information
- OU communication via interpr√®te/accompagnateur

La r√®gle suppose que si une visite r√©guli√®re dure 30+ minutes,
elle pourrait potentiellement qualifier comme intervention clinique
si les crit√®res cliniques sont remplis.

Format des heures :
- D√©but/Fin au format HH:MM (ex: "10:00", "14:30")
- Calcul traverse minuit si n√©cessaire (ex: 23:30 √† 00:15 = 45 min)

Arrondissement des p√©riodes suppl√©mentaires :
- Arrondi AU SUP√âRIEUR par tranches de 15 minutes
- Exemple : 32 minutes = 30 min base (pas de p√©riode suppl√©mentaire)
- Exemple : 45 minutes = 30 min base + 15 min suppl√©mentaire
- Exemple : 46 minutes = 30 min base + 15 min suppl√©mentaire (arrondi)
```

---

## Approval & Sign-off

**Requested By**: Direction m√©dicale
**Date Requested**: 2025-01-10
**Approved By**: Service de facturation
**Implementation Date**: 2025-10-11
**Status**: ‚úÖ Impl√©ment√© et test√©
**Test Coverage**: 100% (29 test cases)
