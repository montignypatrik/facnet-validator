# Example Rule: Office Fee Validation (Frais de Bureau)

This is a complete example showing how to fill out the rule template.

---

## Rule Information

**Rule Name (French)**: `Frais de bureau (19928/19929)`

**Rule ID**: `OFFICE_FEE_19928_19929`

**Rule Type**: `office_fee_validation` (custom type)

**Severity**: `error`

**Category**: `office_fees`

---

## Rule Logic Description

### What This Rule Validates:
```
This rule validates daily office fee maximums for Quebec billing codes
19928 and 19929. Each code has different patient count requirements
and thresholds based on whether patients are registered or walk-in.

The rule also enforces:
1. Codes can only be billed in cabinet (not établissement)
2. Daily maximum of $64.80 per doctor
3. Different thresholds for registered vs walk-in patients
4. Walk-in patients must have context codes G160 or AR
```

### When Should This Trigger?
```
Trigger when:
1. Code 19928 billed with <6 registered patients (minimum requirement)
2. Code 19928 billed with >10 walk-in patients (maximum allowed)
3. Code 19929 billed with <12 registered patients (minimum requirement)
4. Code 19929 billed with >20 walk-in patients (maximum allowed)
5. Daily total for doctor exceeds $64.80
6. Codes billed in établissement instead of cabinet
7. Walk-in patient missing G160 or AR context code
```

### When Should This NOT Trigger?
```
Should NOT trigger when:
1. Code 19928 with 6-10 patients (within limits)
2. Code 19929 with 12-20 patients (within limits)
3. Daily total ≤ $64.80
4. Billed in cabinet (establishment code 5XXXX)
5. Walk-in patients have proper context codes
```

---

## Target Data

### Target Billing Codes:
```javascript
codes: ["19928", "19929"]
```

### Required Context Elements:
```javascript
walkInContexts: ["G160", "AR"]  // Sans rendez-vous contexts
```

### Establishment Restrictions:
```javascript
allowedEstablishments: ["cabinet"]  // Codes starting with 5XXXX
excludedEstablishments: ["établissement", "urgence"]
```

---

## Thresholds & Limits

### Daily Maximum:
```javascript
dailyMaximum: 64.80  // Maximum dollars per doctor per day
```

### Patient Count Requirements:
```javascript
code19928: {
  registeredMinimum: 6,   // Minimum patients inscrits
  walkInMaximum: 10,      // Maximum patients sans RDV
  tariff: 6.48           // Per-patient amount
}

code19929: {
  registeredMinimum: 12,  // Minimum patients inscrits
  walkInMaximum: 20,      // Maximum patients sans RDV
  tariff: 3.24           // Per-patient amount
}
```

### Time Periods:
```javascript
period: "daily"
periodStart: "00:00"
periodEnd: "23:59"
```

---

## Error Messages (French)

### Scenario 1: Not Enough Registered Patients (Code 19928)
```
Message: "Code 19928 exige un minimum de 6 patients inscrits. Actuellement: 3 patients inscrits."

Solution: "Changez le code 19929 pour 19928 ou corrigez les visites non payées"
```

### Scenario 2: Not Enough Registered Patients (Code 19929)
```
Message: "Code 19929 exige un minimum de 12 patients inscrits. Actuellement: 8 patients inscrits."

Solution: "Veuillez annuler la demande ou corrigez les visites non payées"
```

### Scenario 3: Too Many Walk-In Patients
```
Message: "Code 19928 permet maximum 10 patients sans RDV. Actuellement: 12 patients sans RDV alors que le code exige la présence de contexte #G160 ou #AR."

Solution: "Réduisez le nombre de patients sans rendez-vous ou vérifiez les contextes"
```

### Scenario 4: Daily Maximum Exceeded
```
Message: "Le maximum quotidien de 64.80$ pour les frais de bureau a été dépassé pour ce médecin"

Solution: "Réduisez le nombre de factures ou annulez certaines demandes"
```

### Scenario 5: Wrong Location
```
Message: "Les codes 19928 et 19929 peuvent seulement être facturés en cabinet"

Solution: "Changez le lieu de pratique ou utilisez un code différent"
```

---

## Test Scenarios

### A. Patients Inscrits (Registered Patients) - Scenarios 1-5

#### Scenario 1: Insufficient Inscrits for 19928 (FAIL)
```
Type: Inscrits
Patients Inscrits: 3
Patients Sans RDV: 0
Code: 19928
Montant: $32.40
Status: Erreur
Message: "Le code 19929 requiert la presence d'un minimum de 12 patients inscrit allors qu'on en trouve seullement 3 pour cette date de service"
Solution: "Veuillez annuler la demande ou corriger les visites non payé"
```

#### Scenario 2: Valid Inscrits for 19928 (PASS)
```
Type: Inscrits
Patients Inscrits: 8
Patients Sans RDV: 0
Code: 19928
Montant: $32.40
Status: Succès
Message: Aucune erreur - Correspondance parfaite
```

#### Scenario 3: Inscrits Qualify for 19929 Upgrade (WARNING)
```
Type: Inscrits
Patients Inscrits: 15
Patients Sans RDV: 0
Code: 19928
Montant: $32.40
Status: Avertissement
Message: "15 patients inscrits ont ete vu, vous avez donc droit au code 19929"
Solution: "Remplacez le code 19928 par 19929 pour maximiser le remboursement."
```

#### Scenario 4: Valid Inscrits for 19929 (PASS)
```
Type: Inscrits
Patients Inscrits: 15
Patients Sans RDV: 0
Code: 19929
Montant: $64.80
Status: Succès
Message: Aucune erreur - Correspondance parfaite
```

#### Scenario 5: Insufficient Inscrits for 19929 (FAIL)
```
Type: Inscrits
Patients Inscrits: 8
Patients Sans RDV: 0
Code: 19929
Montant: $64.80
Status: Erreur
Message: "Le code 19929 requiert la presence d'un minimum de 12 patients inscrit allors qu'on en trouve seullement 8 pour cette date de service"
Solution: "Changez le code 19929 pour 19928 ou corriger les visites non payé"
```

### B. Patients Sans RDV (Walk-in Patients) - Scenarios 6-10

#### Scenario 6: Insufficient Sans RDV for 19928 (FAIL)
```
Type: Sans RDV
Patients Inscrits: 0
Patients Sans RDV: 7
Code: 19928
Montant: $32.40
Status: Erreur
Message: "Le code 19928 requiert la presence d'un minimum de 10 patients sans rendez-vous allors qu'on en trouve seullement 7 pour cette date de service"
Solution: "Veuillez annuler la demande ou corriger les visites non payé"
```

#### Scenario 7: Valid Sans RDV for 19928 (PASS)
```
Type: Sans RDV
Patients Inscrits: 0
Patients Sans RDV: 15
Code: 19928
Montant: $32.40
Status: Succès
Message: Aucune erreur - Correspondance parfaite
```

#### Scenario 8: Sans RDV Qualify for 19929 Upgrade (WARNING)
```
Type: Sans RDV
Patients Inscrits: 0
Patients Sans RDV: 23
Code: 19928
Montant: $32.40
Status: Avertissement
Message: "23 patients sans rendez-vous ont ete vu, vous avez donc droit au code 19929"
Solution: "Remplacez le code 19928 par 19929 pour maximiser le remboursement."
```

#### Scenario 9: Valid Sans RDV for 19929 (PASS)
```
Type: Sans RDV
Patients Inscrits: 0
Patients Sans RDV: 23
Code: 19929
Montant: $64.80
Status: Succès
Message: Aucune erreur - Correspondance parfaite
```

#### Scenario 10: Insufficient Sans RDV for 19929 (FAIL)
```
Type: Sans RDV
Patients Inscrits: 0
Patients Sans RDV: 15
Code: 19929
Montant: $64.80
Status: Erreur
Message: "Le code 19929 requiert la presence d'un minimum de 20 patients sans rendez-vous allors qu'on en trouve seullement 15 pour cette date de service"
Solution: "Changez le code 19929 pour 19928 ou corriger les visites non payé"
```

### C. Daily Maximum Scenarios - Scenarios 11-12

#### Scenario 11: Double 19928 Within Maximum (PASS)
```
Type: Maximum
Patients Inscrits: 10
Patients Sans RDV: 10
Codes: 19928 + 19928
Montant: $64.80
Status: Succès
Message: Aucune erreur - Dans le maximum quotidien
```

#### Scenario 12: Double 19929 Exceeds Maximum (FAIL)
```
Type: Maximum
Patients Inscrits: 15
Patients Sans RDV: 22
Codes: 19929 + 19929
Montant: $129.60
Status: Erreur
Message: "Le maximum quotidien de 64.80 pour les frais de bureau a ete depasse pour ce medecin"
Solution: "Veuillez annuler un des deux frais de bureau"
```

### D. Établissement Validation - Scenarios 13-14

#### Scenario 13: Valid Cabinet Location (PASS)
```
Type: Établissement
Patients Inscrits: 10
Patients Sans RDV: 0
Code: 19928
Établissement: Cabinet (5xxxxx)
Montant: $32.40
Status: Succès
Message: Aucune erreur - Établissement valide
```

#### Scenario 14: Invalid Hospital Location (FAIL)
```
Type: Établissement
Patients Inscrits: 10
Patients Sans RDV: 0
Code: 19928
Établissement: Hôpital (2xxxxx)
Montant: $32.40
Status: Erreur
Message: "Les codes 19928 et 19929 peuvent seulement etre facture en cabinet"
Solution: "Veuillez annuler la demande"
```

### E. Mixte - Double Billing - Scenarios 15A-18A

#### Scenario 15A: Mixed Double 19928 Valid (PASS)
```
Type: Mixte - Double
Patients Inscrits: 8
Patients Sans RDV: 15
Codes: 19928 + 19928
Montant: $64.80
Status: Succès
Message: Aucune erreur - Dans le maximum quotidien
```

#### Scenario 16A: Mixed Double 19928 Upgrade Available (WARNING)
```
Type: Mixte - Double
Patients Inscrits: 7
Patients Sans RDV: 12
Codes: 19928 + 19928
Montant: $64.80
Status: Avertissement
Message: "12 patients sans rendez-vous ont ete vu, vous avez donc droit au code 19929 mais cela depasserai le maximum quotidien"
Solution: "Changez le 19928 sans RDV pour 19929 et annulez le 19928 inscrits"
```

#### Scenario 17A: Mixed Double 19929 Exceeds Maximum (FAIL)
```
Type: Mixte - Double
Patients Inscrits: 14
Patients Sans RDV: 22
Codes: 19929 + 19929
Montant: $129.60
Status: Erreur
Message: "Le maximum quotidien de 64.80 pour les frais de bureau a ete depasse pour ce medecin"
Solution: "Veuillez annuler un des deux frais de bureau"
```

#### Scenario 18A: Mixed Double Both Insufficient (FAIL)
```
Type: Mixte - Double
Patients Inscrits: 5
Patients Sans RDV: 8
Codes: 19928 + 19928
Montant: $64.80
Status: Erreur
Message: "Le code 19928 inscrits requiert un minimum de 6 patients allors qu'on en trouve 5 et le code 19928 sans RDV requiert un minimum de 10 patients allors qu'on en trouve 8"
Solution: "Veuillez annuler les deux demandes ou corriger les visites non payé"
```

### F. Mixte - Simple Billing - Scenarios 19B-22B

#### Scenario 19B: Inscrits Billed, Sans RDV Available (WARNING)
```
Type: Mixte - Simple
Patients Inscrits: 8
Patients Sans RDV: 15
Code: 19928 (inscrits)
Montant: $32.40
Status: Avertissement
Message: "Vous avez aussi vu 15 patients sans RDV et vous pourriez facturer un autre 19928 pour atteindre le maximum quotidien de 64.80"
Solution: "Ajoutez un deuxieme 19928 pour les patients sans RDV"
```

#### Scenario 20B: Sans RDV Billed, Inscrits Available (WARNING)
```
Type: Mixte - Simple
Patients Inscrits: 8
Patients Sans RDV: 15
Code: 19928 (sans RDV)
Montant: $32.40
Status: Avertissement
Message: "Vous avez aussi vu 8 patients inscrits et vous pourriez facturer un autre 19928 pour atteindre le maximum quotidien de 64.80"
Solution: "Ajoutez un deuxieme 19928 pour les patients inscrits"
```

#### Scenario 21B: Mixed 19929 Inscrits Optimal (PASS)
```
Type: Mixte - Simple
Patients Inscrits: 14
Patients Sans RDV: 22
Code: 19929 (inscrits)
Montant: $64.80
Status: Succès
Message: Facturation optimale - Maximum quotidien atteint
```

#### Scenario 22B: Mixed 19929 Sans RDV Optimal (PASS)
```
Type: Mixte - Simple
Patients Inscrits: 14
Patients Sans RDV: 22
Code: 19929 (sans RDV)
Montant: $64.80
Status: Succès
Message: Facturation optimale - Maximum quotidien atteint
```

### G. Strategic Billing Scenarios - Scenarios 23C-29C

#### Scenario 23C: Strategic Mix Exceeds Maximum (FAIL)
```
Type: Stratégique
Patients Inscrits: 6
Patients Sans RDV: 25
Codes: 19928 + 19929
Montant: $97.20
Status: Erreur
Message: "Le maximum quotidien de 64.80 pour les frais de bureau a ete depasse pour ce medecin"
Solution: "Annulez le 19928 inscrits et gardez seulement le 19929 sans RDV"
```

#### Scenario 24C: Strategic Reverse Mix Exceeds Maximum (FAIL)
```
Type: Stratégique
Patients Inscrits: 15
Patients Sans RDV: 12
Codes: 19929 + 19928
Montant: $97.20
Status: Erreur
Message: "Le maximum quotidien de 64.80 pour les frais de bureau a ete depasse pour ce medecin"
Solution: "Annulez le 19928 sans RDV et gardez seulement le 19929 inscrits"
```

#### Scenario 25C: Strategic Inscrits with Available Sans RDV (WARNING)
```
Type: Stratégique
Patients Inscrits: 7
Patients Sans RDV: 11
Code: 19928 (inscrits)
Montant: $32.40
Status: Avertissement
Message: "Vous avez aussi vu 11 patients sans RDV et vous pourriez facturer un autre 19928 pour atteindre le maximum quotidien de 64.80"
Solution: "Ajoutez un deuxieme 19928 pour les patients sans RDV"
```

#### Scenario 26C: Strategic Choice Both Qualify (PASS)
```
Type: Stratégique
Patients Inscrits: 13
Patients Sans RDV: 21
Code: 19929 (groupe choisi)
Montant: $64.80
Status: Succès
Message: Facturation optimale - Les deux groupes qualifient mais vous ne pouvez choisir qu'un seul
```

#### Scenario 27C: Strategic Sans RDV Only (PASS)
```
Type: Stratégique
Patients Inscrits: 4
Patients Sans RDV: 23
Code: 19929 (sans RDV)
Montant: $64.80
Status: Succès
Message: Facturation optimale - Maximum quotidien atteint
```

#### Scenario 28C: Strategic Inscrits Only (PASS)
```
Type: Stratégique
Patients Inscrits: 18
Patients Sans RDV: 7
Code: 19929 (inscrits)
Montant: $64.80
Status: Succès
Message: Facturation optimale - Maximum quotidien atteint
```

#### Scenario 29C: Strategic Sans RDV with Available Inscrits (WARNING)
```
Type: Stratégique
Patients Inscrits: 9
Patients Sans RDV: 18
Code: 19928 (sans RDV)
Montant: $32.40
Status: Avertissement
Message: "Vous avez aussi vu 9 patients inscrits et vous pourriez facturer un autre 19928 pour atteindre le maximum quotidien de 64.80"
Solution: "Ajoutez un deuxieme 19928 pour les patients inscrits"
```

### H. Edge Case Scenarios

#### Edge Case 1: Patient with no montantPaye (NULL or 0)
```
Expected: Treated as unpaid, doesn't count toward minimum
```

#### Edge Case 2: Mixed paid/unpaid patients
```
Expected: Only paid patients count toward thresholds
```

#### Edge Case 3: Walk-in patient missing G160/AR context
```
Expected: Still counts but gets separate error about missing context
```

#### Edge Case 4: Same patient multiple visits same day
```
Expected: Each visit counts separately toward totals
```

---

## Additional Requirements

### Special Validation Logic:
```javascript
// Paid vs unpaid detection
isPaid = (record.montantPaye > 0)

// Registered vs walk-in detection
isWalkIn = record.elementContexte.includes("G160") || record.elementContexte.includes("AR")

// Establishment type detection
isCabinet = record.lieuPratique.startsWith("5")

// Grouping
groupBy: doctor + date (daily validation per doctor)
```

### Dependencies on Other Tables:
```
- establishments table: To verify cabinet vs établissement
- contexts table: To validate G160/AR requirements
- codes table: Not required (codes hardcoded)
```

### Performance Considerations:
```
This rule processes every billing record and groups by doctor+date.
For a file with 10,000 records and 50 doctors:
- 50 doctor-day groups to validate
- ~200 records per group average
- Executes in <100ms

No special optimization needed.
```

---

## Examples from Real Data

### Example CSV Input (Scenario 5 from test file):
```csv
#,Facture,ID RAMQ,Date de Service,Lieu de pratique,Code,Unités,Élement de contexte,Montant Preliminaire,Montant payé,Doctor Info,Patient
1,F1,R1,2025-01-06,50001,19929,1,G160,3.24,3.24,DR-001,P1
2,F2,R2,2025-01-06,50001,19929,1,G160,3.24,3.24,DR-001,P2
3,F3,R3,2025-01-06,50001,19929,1,G160,3.24,3.24,DR-001,P3
4,F4,R4,2025-01-06,50001,19929,1,G160,3.24,3.24,DR-001,P4
5,F5,R5,2025-01-06,50001,19929,1,G160,3.24,3.24,DR-001,P5
6,F6,R6,2025-01-06,50001,19929,1,G160,3.24,3.24,DR-001,P6
7,F7,R7,2025-01-06,50001,19929,1,G160,3.24,3.24,DR-001,P7
8,F8,R8,2025-01-06,50001,19929,1,G160,3.24,3.24,DR-001,P8
```

### Expected Validation Output:
```json
{
  "severity": "error",
  "category": "office_fees",
  "message": "Code 19929 exige un minimum de 12 patients inscrits. Actuellement: 0 patients inscrits.",
  "solution": "Veuillez annuler la demande ou corrigez les visites non payées",
  "ruleData": {
    "code": "19929",
    "date": "2025-01-06",
    "doctor": "DR-001",
    "registeredPaidCount": 0,
    "walkInPaidCount": 8,
    "required": 12,
    "actual": 0
  }
}
```

---

## Implementation Priority

**Priority**: `High`

**Estimated Complexity**: `Complex`
- Custom grouping by doctor+date
- Multiple validation criteria
- Different thresholds per code
- Paid/unpaid detection
- Context validation

**Business Impact**:
```
Critical - Office fees represent ~30% of monthly billing revenue ($15K-20K).
RAMQ frequently rejects these claims for threshold violations.
Last month: 23 rejections totaling $1,247 in lost revenue.

Implementing this rule prevents rejection and saves ~2 hours/week
of manual claim review.
```

---

## Notes & Clarifications

```
Context codes G160 and AR indicate "sans rendez-vous" (walk-in) visits.
These are common in walk-in clinics and emergency situations.

The 19929 code is designed for high-volume practices with many registered
patients (12+ per day), while 19928 is for smaller practices (6+ per day).

Cabinet establishments are identified by codes starting with "5" (50001-59999).
Établissement codes start with "2" (20001-29999).
Urgence codes start with "3" (30001-39999).

Daily maximum of $64.80 = 10 billings of 19928 ($6.48) or 20 billings of
19929 ($3.24), ensuring fair compensation while preventing over-billing.
```

---

## Approval & Sign-off

**Requested By**: Dr. Martin (Medical Director)
**Date Requested**: 2024-12-15
**Approved By**: Finance Department
**Implementation Deadline**: 2025-01-15
**Status**: ✅ Implemented and tested (2025-01-06)
